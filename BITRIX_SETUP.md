Настройка интеграции с Битрикс24

Быстрый старт
1. Вебхук в Битрикс24

Захожу в свой аккаунт Битрикс24.

В меню Приложения → Разработчикам → Входящий вебхук.

Создаю новый вебхук с правами:

CRM (чтение/запись)

Пользователи (чтение)

Копирую ссылку вебхука (она мне потом нужна в проекте).

2. Подключение в проект

Есть два способа:

Вариант А (лучше) — через переменные окружения.
Создаю файл .env.local в корне проекта и вставляю туда:

BITRIX_WEBHOOK_URL=ссылка-на-мой-вебхук


Вариант B — через конфиг.
В файле src/config/bitrix.ts прописываю:

export const BITRIX_CONFIG = {
  WEBHOOK_URL: 'ссылка-на-мой-вебхук',
};

3. Проверка

Запускаю проект: npm run dev.

Перехожу на страницу «Тест Битрикс».

Жму кнопку "Тест подключения" → должен вернуться список пользователей.

Жму кнопку "Тест создания контакта" → в Битриксе появляется тестовый контакт.

4. Как проверить работу интеграции

Регистрация: создаю нового пользователя → в Битрикс24 (CRM → Контакты) появляется новый контакт.

Платежи: перехожу на страницу «Платежи» → подтягиваются сделки из Битрикса. Нажимаю «Оплатить» → сделка меняет стадию на «В работе»/«Оплачено».

5. Настройка стадий сделок

Чтобы статусы отображались правильно:

В Битриксе открываю CRM → Настройки → Стадии сделок.

Проверяю, чтобы были такие стадии:

NEW (новая, не оплачено)

WON (оплачено)

LOSE (отменено)

6. Возможные ошибки

Invalid webhook format → проверь ссылку вебхука.

401 Bitrix API error → у вебхука нет нужных прав (добавь CRM + пользователи).

Network error → проверь интернет или CORS.

7. Где смотреть ошибки

В консоли браузера (F12).

В консоли Next.js (где запускается сервер).

В логах самого Битрикса (раздел «Входящий вебхук»).

8. Чек-лист (чтобы понять, всё ли готово)

 Вебхук создан и работает

 Ссылка вебхука прописана в проекте

 Тест подключения к API проходит

 Контакт в Битрикс создаётся при регистрации

 Платежи подгружаются

 Кнопка «Оплатить» меняет стадию сделки
